name: Code Quality & Compilation Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened, ready_for_review ]
  push:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release

jobs:
  validate-code:
    name: Validate Code Structure
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install basic build tools
      run: |
        echo "üîç Performing static code analysis and basic compilation checks"
        echo "Note: No GPU testing available on GitHub Actions"
        echo ""

        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          gcc \
          g++ \
          build-essential \
          pkg-config

    - name: Check code formatting and structure
      run: |
        echo "=== Code Quality Analysis ==="

        # Check for basic syntax issues
        echo "Checking C++ files for syntax..."
        syntax_errors=0
        find src/ include/ tests/ -name "*.cpp" -o -name "*.cu" -o -name "*.cuh" -o -name "*.h" | \
        while read file; do
          if [ -f "$file" ]; then
            echo "  Checking $file..."
            # Basic syntax check
            if ! head -100 "$file" > /tmp/syntax_check.cpp 2>/dev/null; then
              echo "  ‚ö†Ô∏è Cannot read file: $file"
              continue
            fi
            if ! gcc -fsyntax-only -x c++ /tmp/syntax_check.cpp 2>/dev/null; then
              echo "  ‚ùå Syntax error in $file"
              syntax_errors=$((syntax_errors + 1))
            fi
          fi
        done

        echo "Syntax check complete. Found $syntax_errors potential issues."

    - name: Check for common issues
      run: |
        echo "=== Code Quality Checks ==="

        # Check for TODO/FIXME comments in production code
        todo_count=$(grep -r "TODO\|FIXME\|XXX" src/ include/ --include="*.cpp" --include="*.cu" --include="*.h" | grep -v "test_" | wc -l)
        if [ "$todo_count" -gt 0 ]; then
          echo "‚ö†Ô∏è Found $todo_count TODO/FIXME comments in production code:"
          grep -r "TODO\|FIXME\|XXX" src/ include/ --include="*.cpp" --include="*.cu" --include="*.h" | grep -v "test_" | head -10
        else
          echo "‚úÖ No TODO/FIXME comments found in production code"
        fi

        # Check for long lines (>120 characters)
        long_lines=$(find src/ include/ tests/ -name "*.cpp" -o -name "*.cu" -o -name "*.cuh" -o -name "*.h" | \
                     xargs awk 'length($0) > 120 { print FILENAME ":" NR ":" $0 }' | wc -l)
        if [ "$long_lines" -gt 0 ]; then
          echo "‚ö†Ô∏è Found $long_lines lines longer than 120 characters"
          find src/ include/ tests/ -name "*.cpp" -o -name "*.cu" -o -name "*.cuh" -o -name "*.h" | \
            xargs awk 'length($0) > 120 { print FILENAME ":" NR ":" $0 }' | head -5
        else
          echo "‚úÖ No lines exceed 120 characters"
        fi

        # Check CMakeLists.txt syntax
        if [ -f "CMakeLists.txt" ]; then
          echo "‚úÖ CMakeLists.txt found"
        else
          echo "‚ùå CMakeLists.txt not found"
          exit 1
        fi

    - name: Validate project structure
      run: |
        echo "=== Project Structure Validation ==="

        # Check for required directories
        required_dirs=("src" "include" "tests")
        for dir in "${required_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "‚úÖ $dir/ directory exists"
          else
            echo "‚ùå $dir/ directory missing"
          fi
        done

        # Check for key header files
        key_headers=("include/gsdr/gsdr.h" "include/gsdr/qpsk.h" "include/gsdr/qpsk256.h")
        for header in "${key_headers[@]}"; do
          if [ -f "$header" ]; then
            echo "‚úÖ $header exists"
          else
            echo "‚ö†Ô∏è $header not found"
          fi
        done

        # Check for test files
        test_files=$(find tests/ -name "test_*.cpp" 2>/dev/null | wc -l)
        if [ "$test_files" -gt 0 ]; then
          echo "‚úÖ Found $test_files test files"
        else
          echo "‚ö†Ô∏è No test files found"
        fi

    - name: Generate validation report
      if: always()
      run: |
        echo "## üîç GSDR Code Quality & Structure Report" > validation_report.md
        echo "" >> validation_report.md
        echo "| Check | Status | Details |" >> validation_report.md
        echo "|-------|--------|---------|" >> validation_report.md

        # Syntax check status
        syntax_errors=$(find src/ include/ tests/ -name "*.cpp" -o -name "*.cu" -o -name "*.cuh" -o -name "*.h" | \
                       xargs -I {} sh -c 'head -100 "{}" > /tmp/syntax_check.cpp 2>/dev/null && gcc -fsyntax-only -x c++ /tmp/syntax_check.cpp 2>/dev/null || echo "error"' | \
                       grep -c "error" || echo "0")

        if [ "$syntax_errors" -eq 0 ]; then
          echo "| Syntax Validation | ‚úÖ PASS | All C++ files compile without syntax errors |" >> validation_report.md
        else
          echo "| Syntax Validation | ‚ùå FAIL | $syntax_errors files have syntax issues |" >> validation_report.md
        fi

        # TODO check
        todo_count=$(grep -r "TODO\|FIXME\|XXX" src/ include/ --include="*.cpp" --include="*.cu" --include="*.h" | grep -v "test_" | wc -l)
        if [ "$todo_count" -eq 0 ]; then
          echo "| Code Quality | ‚úÖ PASS | No TODO/FIXME comments in production code |" >> validation_report.md
        else
          echo "| Code Quality | ‚ö†Ô∏è WARN | $todo_count TODO/FIXME comments found |" >> validation_report.md
        fi

        # Structure check
        if [ -d "src" ] && [ -d "include" ] && [ -d "tests" ] && [ -f "CMakeLists.txt" ]; then
          echo "| Project Structure | ‚úÖ PASS | All required directories and files present |" >> validation_report.md
        else
          echo "| Project Structure | ‚ùå FAIL | Missing required directories or files |" >> validation_report.md
        fi

        echo "" >> validation_report.md
        echo "### üìã Summary" >> validation_report.md
        echo "- **Validation Date**: $(date)" >> validation_report.md
        echo "- **Files Checked**: $(find src/ include/ tests/ -name "*.cpp" -o -name "*.cu" -o -name "*.cuh" -o -name "*.h" | wc -l)" >> validation_report.md
        echo "- **Test Files**: $(find tests/ -name "test_*.cpp" | wc -l)" >> validation_report.md
        echo "- **CUDA Runtime**: Not available (GitHub Actions limitation)" >> validation_report.md
        echo "" >> validation_report.md
        echo "### ‚ö†Ô∏è Important Notes" >> validation_report.md
        echo "- **GPU Testing**: Not available on GitHub Actions (no CUDA hardware)" >> validation_report.md
        echo "- **Compilation**: Code structure validated for syntax and organization" >> validation_report.md
        echo "- **Actual Testing**: Run tests locally on systems with CUDA-capable GPUs" >> validation_report.md
        echo "" >> validation_report.md
        echo "---" >> validation_report.md
        echo "*Generated by GitHub Actions CI*" >> validation_report.md

    - name: Comment PR with validation results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = 'validation_report.md';

          if (fs.existsSync(path)) {
            const report = fs.readFileSync(path, 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          } else {
            const fallbackComment = `## üîç GSDR Code Quality Check

‚úÖ **Validation Status**: ${{ job.status == 'success' ? 'PASSED' : 'FAILED' }}

### What Was Checked:
- ‚úÖ Syntax validation of all C++/CUDA files
- ‚úÖ Code quality (TODO/FIXME comments)
- ‚úÖ Project structure and required files
- ‚úÖ Build system configuration

### Important Notes:
- **GPU Testing**: Not available on GitHub Actions
- **Compilation**: Code structure validated
- **Runtime Testing**: Requires CUDA-capable hardware

### For GPU Testing:
\`\`\`bash
mkdir build && cd build
cmake .. -DUSE_TESTS=ON
make
ctest --output-on-failure
\`\`\`

*Generated by GitHub Actions CI*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: fallbackComment
            });
          }